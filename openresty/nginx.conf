pcre_jit on;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    # 引入 Lua 模組路徑
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";
    
    # 全局默認設置
    init_by_lua_block {
        -- 預加載 resty.core
        require "resty.core"
    }

    resolver 1.1.1.1 8.8.4.4;
    
    include       mime.types;
    default_type  application/octet-stream;

    # 定義 JSON 格式的 log format
    log_format json_trace escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"http_referer":"$http_referer",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"server_name": "$server_name",'
        '"server_port": $server_port,'
        '"trace_id":"$sent_http_traceparent",'
        '"http_user_agent":"$http_user_agent"'
    '}';

    access_log  /tmp/access.log  json_trace buffer=32k flush=1s;

    # 使用新的 log format
    access_log /usr/local/openresty/nginx/logs/access.log json_trace;

    # See Move default writable paths to a dedicated directory (#119)
    # https://github.com/openresty/docker-openresty/issues/119
    client_body_temp_path /var/run/openresty/nginx-client-body;
    proxy_temp_path       /var/run/openresty/nginx-proxy;
    fastcgi_temp_path     /var/run/openresty/nginx-fastcgi;
    uwsgi_temp_path       /var/run/openresty/nginx-uwsgi;
    scgi_temp_path        /var/run/openresty/nginx-scgi;

    sendfile        on;
    keepalive_timeout  65;
    gzip  on;

    include /etc/nginx/conf.d/*.conf;
}