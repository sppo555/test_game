pcre_jit on;



#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    # 全局共享字典，用於存儲指標數據
    lua_shared_dict trace_metrics 10m;
    
    # 引入 Lua 模組路徑
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";
    
    # 全局默認設置
    init_by_lua_block {
        -- 預加載 resty.core
        require "resty.core"
    }

    # 設置 trace_id 變量
    init_worker_by_lua_block {
        require "resty.core"
    }

    # 定義 trace_id 變量
    # set $trace_id '';

    # 在每個請求開始時設置 trace_id
    access_by_lua_block {
        local trace_context = require "w3c_trace"
        local ctx = trace_context.get_trace_context()
        if ctx and ctx.trace_id then
            ngx.var.trace_id = ctx.trace_id
        end
    }

    resolver 1.1.1.1 8.8.4.4;
    
    include       mime.types;
    default_type  application/octet-stream;

    # Enables or disables the use of underscores in client request header fields.
    # When the use of underscores is disabled, request header fields whose names contain underscores are marked as invalid and become subject to the ignore_invalid_headers directive.
    # underscores_in_headers off;

    # log_format  main  '[$time_local] $remote_addr - $remote_user "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"'
    #                  'UUID=$request_id';

    # 定義 JSON 格式的 log format
    log_format json_trace escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"http_referer":"$http_referer",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"server_name": "$server_name",'
        '"server_port": $server_port,'
        '"trace_id":"$sent_http_traceparent",'
        '"http_user_agent":"$http_user_agent"'
    '}';

    access_log  /tmp/access.log  json_trace buffer=32k flush=1s;

    # 使用新的 log format
    access_log /usr/local/openresty/nginx/logs/access.log json_trace;

    # See Move default writable paths to a dedicated directory (#119)
    # https://github.com/openresty/docker-openresty/issues/119
    client_body_temp_path /var/run/openresty/nginx-client-body;
    proxy_temp_path       /var/run/openresty/nginx-proxy;
    fastcgi_temp_path     /var/run/openresty/nginx-fastcgi;
    uwsgi_temp_path       /var/run/openresty/nginx-uwsgi;
    scgi_temp_path        /var/run/openresty/nginx-scgi;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip  on;

    include /etc/nginx/conf.d/*.conf;

    # Don't reveal OpenResty version to clients.
    # server_tokens off;
}

include /etc/nginx/conf.d/*.main;